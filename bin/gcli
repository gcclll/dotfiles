#!/usr/bin/env bash
set -euo pipefail

source $GCLRC_SHELL/utils

bin=${0##*/}

usage() {
    color_info 'Usage: gcli <COMMAND> [OPTIONS] ...
COMMAND:

d)  aria2c, Download everything...

    https://aria2.github.io/manual/en/html/aria2c.html

    Options:

        -p,     Use proxy, http://127.0.0.1:7890

sl*) sunlight command line tools

     gcli slu <local> <remote>, upload file to remote host

     gcli sld <remote> <local>, download file from remote host

     eg.

        1. gcli slu dvs       upload dvs-basic/README.html to 192.168.88.158/lzc/
        2. gcli slu 46        upload release epg tar file to 192.168.88.46:/usr/local/pkgs/EPG/EPG30
        3. gcli slu cms       upload cmsepg/README.html to 192.168.88.158/lzc/
        4. gcli slu cmsr      upload cmsepg/docs/release.html to 192.168.88.158/lzc/

'
}

_aria2c() {
    option=""
    proxy=""
    n=$#

    while getopts "pi:" o; do
        case "$o" in
            p)
                option=$option" --http-proxy=http://127.0.0.1:7890"
                n=$((n + 1))
                ;;
            ?) echo '' ;;
        esac
    done

    # if [ "$1" == "p" ]; then
    # option=option" --http-proxy=http://127.0.0.1:7891"
    # fi

    if [ $n -gt 1 ]; then
        n=$((n - 1))
    fi
    aria2c -d ~/Downloads $option ${@:n}
}

_sync() {
    cmd="$1"
    case $cmd in
        mb)
            if [ $# -gt 1 ]; then
                mbsync "$2" | mu index
            else
                mbsync -a | mu index
            fi
            ;;
    esac
}

s158="root@192.168.88.158:/var/www/html/lzc"
s46="root@192.168.88.46:/usr/local/pkgs/EPG/EPG30"
url_158="http://192.168.88.158/lzc"
init_pk="/usr/local/sunlight/sshkeys/init.pk"
cmd_scp="scp -r -o IdentitiesOnly=yes -i $init_pk"
dvs_rm="$HOME/github/aliyun/server-ui/dvs-basic/README.html"
cms_rm="$EPG_NC_HOME/README.html"
cms_re="$EPG_NC_HOME/docs/release.html"
chmod_158() {
    ssh -i $init_pk -o IdentitiesOnly=yes root@192.168.88.158 '/usr/bin/chmod -R 777 /var/www/html/lzc'
}

sl_upload_with_open() {
    file="$1"
    name="$2"
    link=$url_158"/$name.html"
    $cmd_scp $file $s158"/$name.html"
    print_link $link
    chmod_158
    open $link
}

sl_upload() {
    file="$1"

    if [ "$1" == "dvs" ]; then
        sl_upload_with_open $dvs_rm "dvs_readme"
    elif [ "$1" == "46" ]; then
        file="$2"
        echo "> Target: $file"
        $cmd_scp $file "$s46/"
    elif [ "$1" == "cms" ]; then
        sl_upload_with_open $cms_rm "cms_readme"
    elif [ "$1" == "cmsr" ]; then
        sl_upload_with_open $cms_re "cms_release"
    elif [ "$1" == "s" ]; then
        file="$2"
        echo "> Target: $file"
        $cmd_scp $file "$3"
    fi
    echo "> Upload DONE."
}

sl_download() {
    remote="$1"
    localfile="$2"
    $cmd_scp "$remote" "$localfile"
}

if [ $# -lt 1 ]; then
    usage
    exit 1
fi
cmd="$1"

case $cmd in
    d) _aria2c "${@:2}" ;; # d -> download
    s) _sync "${@:2}" ;;   # s -> sync
    slu) sl_upload "${@:2}" ;;
    sld) sl_download "${@:2}" ;;
    deno-zsh)
        test_dir ~/.zsh
        deno completions zsh >~/.zsh/_deno
        echo "fpath=(~/.zsh $fpath)" >>$GCLRC_HOME/.zshrc
        echo "autoload -Uz compinit" >>$GCLRC_HOME/.zshrc
        echo "compinit -u" >>$GCLRC_HOME/.zshrc
        ;;
    ?) usage ;;
esac

# while getopts 'abc' OPT; do
#     case $OPT in
#         h) usage ;;
#         ?) usage ;;
#     esac
# done
