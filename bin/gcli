#!/usr/bin/env bash
set -euo pipefail

source $GCLRC_SHELL/utils

bin=${0##*/}

usage() {
    color_info 'Usage: gcli <COMMAND> [OPTIONS] ...
COMMAND:

d)  aria2c, Download everything...

    https://aria2.github.io/manual/en/html/aria2c.html

    Options:

        -p,     Use proxy, http://127.0.0.1:7890
'
}

_aria2c() {
    option=""
    proxy=""
    n=$#

    while getopts "pi:" o; do
        case "$o" in
            p)
                option=$option" --http-proxy=http://127.0.0.1:7890"
                n=$((n + 1))
                ;;
            ?) echo '' ;;
        esac
    done

    # if [ "$1" == "p" ]; then
    # option=option" --http-proxy=http://127.0.0.1:7891"
    # fi

    if [ $n -gt 1 ]; then
        n=$((n - 1))
    fi
    aria2c -d ~/Downloads $option ${@:n}
}

_sync() {
    cmd="$1"
    case $cmd in
        mb)
            if [ $# -gt 1 ]; then
                mbsync "$2" | mu index
            else
                mbsync -a | mu index
            fi
            ;;
    esac
}

if [ $# -lt 1 ]; then
    usage
    exit 1
fi
cmd="$1"

case $cmd in
    d) _aria2c "${@:2}" ;; # d -> download
    s) _sync "${@:2}" ;;   # s -> sync
    pub) emacs --script publish.el ;;
    deno-zsh)
        test_dir ~/.zsh
        deno completions zsh >~/.zsh/_deno
        echo "fpath=(~/.zsh $fpath)" >>$GCLRC_HOME/.zshrc
        echo "autoload -Uz compinit" >>$GCLRC_HOME/.zshrc
        echo "compinit -u" >>$GCLRC_HOME/.zshrc
        ;;
    ?) usage ;;
esac
